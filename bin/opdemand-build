#!/bin/sh -e

# source orchestration inputs as environment vars
. /var/cache/opdemand/inputs.sh

# check for a url
is_url=`python -c "print \"$SERVER_BUILD_SCRIPT\".startswith(\"http\")"`
if [ $is_url = True ] ; then
    curl -s -o /var/cache/opdemand/build $SERVER_BUILD_SCRIPT
else
    cp /var/lib/opdemand/$SERVER_BUILD_SCRIPT /var/cache/opdemand/build
fi

# add in any extra bash commands
cat >>/var/cache/opdemand/build<<EOF 

$SERVER_BUILD_ADDITION
EOF


# use relative path to find/exec script as root
chmod +x /var/cache/opdemand/build
/var/cache/opdemand/build 2>&1 | tee -a -i /var/log/opdemand/build.log
